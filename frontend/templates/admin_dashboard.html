<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - FurMed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 95%;
        }
        .dashboard-header {
            background: linear-gradient(to right, #2c3e50, #1a1a2e);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            border-radius: 10px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            font-size: 1.2rem;
            font-weight: bold;
            background: linear-gradient(to right, #34495e, #1c1f26);
            color: white;
            position: relative;
        }
        .chart-container {
            position: relative;
            margin: auto;
            width: 100%;
            max-width: 850px;
            height: 350px;
        }
        .back-btn {
            margin-top: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.3s;
        }
        .back-btn:hover {
            background: #c0392b;
        }
        .download-btn {
            color: white;
            background: #27ae60;
            border: none;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.3s;
        }
        .download-btn:hover {
            background: #219150;
        }
        select.chart-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px;
            border-radius: 4px;
            border: none;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                font-size: 1.5rem;
                padding: 15px;
            }
            .back-btn {
                font-size: 14px;
                padding: 8px 16px;
            }
            .chart-container {
                max-width: 100%;
                height: 300px;
            }
            select.chart-selector {
                top: 5px;
                right: 5px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="dashboard-header">
            <i class="fas fa-user-shield"></i> Admin Dashboard - FurMed
        </div>

        <!-- Predictions Summary -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-notes-medical"></i> Disease Predictions Overview
                <select id="predictionChartType" class="chart-selector">
                    <option value="line">Line Chart</option>
                    <option value="pie">Pie Chart</option>
                    <option value="bar">Bar Chart</option>                    
                    <option value="doughnut">Doughnut Chart</option>
                    <option value="radar">Radar Chart</option>
                </select>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="predictionChart"></canvas>
                </div>
                <div class="table-responsive mt-3">
                    <table class="table table-striped table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Owner</th>
                                <th>Pet Name</th>
                                <th>Pet Type</th>
                                <th>Disease</th>
                                <th>Correct?</th>
                                <th>Corrected Disease</th>
                            </tr>
                        </thead>
                        <tbody id="predictionTableBody"></tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination" id="predictionPagination"></ul>
                </nav>
            </div>
        </div>

        <!-- Donations Summary -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="fas fa-donate"></i> Donations Summary
                <select id="donationChartType" class="chart-selector">
                    <option value="line">Line Chart</option>
                    <option value="bar">Bar Chart</option>
                    <option value="pie">Pie Chart</option>                   
                    <option value="doughnut">Doughnut Chart</option>
                    <option value="radar">Radar Chart</option>
                </select>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="donationChart"></canvas>
                </div>
                <div class="table-responsive mt-3">
                    <table class="table table-striped table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Donor Name</th>
                                <th>Email</th>
                                <th>Amount (INR)</th>
                                <th>Date</th>
                                <th>Invoice</th>
                            </tr>
                        </thead>
                        <tbody id="donationTableBody"></tbody>
                    </table>
                </div>
                
                <div class="text-right mt-3 font-weight-bold text-primary">
                    <h5>Grand Total Donations (All Time): <span id="grandTotalDonation">₹0.00</span></h5>
                </div>
                <nav>
                    <ul class="pagination" id="donationPagination"></ul>
                </nav>
            </div>
        </div>

        <!-- Go Back Button -->
        <div class="text-center">
            <button onclick="goHome()" class="back-btn">
                <i class="fas fa-home"></i> Go Back to Home
            </button>
        </div>
    </div>

    <script>
        let currentDonations = [];
        let currentPredictions = [];

        function goHome() {
            window.location.href = "{{ url_for('route_home') }}";
        }

        // --- Donations Section ---
        function fetchDonations(page = 1) {
            fetch(`/api/get_donations?page=${page}&per_page=10`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success" && data.donations.length > 0) {
                        currentDonations = data.donations;
                        populateDonationTable(currentDonations);
                        renderDonationChart(currentDonations);
                        setupPagination(data.total_pages, page, "donationPagination", fetchDonations);
                        document.getElementById("grandTotalDonation").innerText = `₹${data.grand_total_donations.toFixed(2)}`;
                    } else {
                        document.getElementById("donationChart").style.display = "none";
                    }
                })
                .catch(error => console.error("Error fetching donations:", error));
        }

        function populateDonationTable(donations) {
            const tableBody = document.getElementById("donationTableBody");
            tableBody.innerHTML = "";
            let pageTotal = 0;

            donations.forEach((item, index) => {
                pageTotal += parseFloat(item.amount_inr);
                let row = `<tr>
                    <td>${index + 1}</td>
                    <td>${item.donor_name}</td>
                    <td>${item.donation_email}</td>
                    <td>₹${parseFloat(item.amount_inr).toFixed(2)}</td>
                    <td>${item.date}</td>
                    <td><button class="download-btn" onclick="downloadInvoice('${item.transaction_id}')">Download</button></td>
                </tr>`;
                tableBody.innerHTML += row;
            });

            const totalRow = `<tr class="table-info font-weight-bold">
                <td colspan="3" class="text-right">Total Donations  :</td>
                <td>₹${pageTotal.toFixed(2)}</td>
                <td colspan="2"></td>
            </tr>`;
            tableBody.innerHTML += totalRow;
        }

        function renderDonationChart(donations) {
            const ctx = document.getElementById("donationChart").getContext("2d");
            const labels = donations.map(d => d.donor_name);
            const amounts = donations.map(d => parseFloat(d.amount_inr));
            const selectedType = document.getElementById("donationChartType").value;
            if (window.donationChartInstance) window.donationChartInstance.destroy();
            window.donationChartInstance = new Chart(ctx, {
                type: selectedType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Donation Amount (INR)",
                        data: amounts,
                        backgroundColor: "rgba(54, 162, 235, 0.6)"
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        document.getElementById("donationChartType").addEventListener("change", function() {
            renderDonationChart(currentDonations);
        });

        function setupPagination(totalPages, currentPage, paginationId, fetchFunction) {
            const pagination = document.getElementById(paginationId);
            pagination.innerHTML = "";
            for (let i = 1; i <= totalPages; i++) {
                let li = document.createElement("li");
                li.className = `page-item ${i === currentPage ? "active" : ""}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener("click", () => fetchFunction(i));
                pagination.appendChild(li);
            }
        }

        function downloadInvoice(transactionId) {
            window.location.href = `/static/invoices/invoice_${transactionId}.pdf`;
        }

        // --- Predictions Section ---
        function fetchPredictions(page = 1) {
            fetch(`/api/get_predictions?page=${page}&per_page=10`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success" && data.predictions.length > 0) {
                        currentPredictions = data.predictions;
                        populatePredictionTable(currentPredictions);
                        renderPredictionChart(currentPredictions);
                        setupPagination(data.total_pages, page, "predictionPagination", fetchPredictions);
                    } else {
                        document.getElementById("predictionChart").style.display = "none";
                    }
                })
                .catch(error => console.error("Error fetching predictions:", error));
        }

        function populatePredictionTable(predictions) {
            const tableBody = document.getElementById("predictionTableBody");
            tableBody.innerHTML = "";
            
            predictions.forEach((item, index) => {
                let correctnessBadge = item.is_correct 
                    ? '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Correct</span>' 
                    : '<span class="badge badge-danger"><i class="fas fa-times-circle"></i> Incorrect</span>';

                let correctedDisease = (!item.is_correct && item.correct_label) ? item.correct_label : '-';

                let row = `<tr>
                    <td>${index + 1}</td>
                    <td>${item.owner_name}</td>
                    <td>${item.pet_name}</td>
                    <td>${item.pet_type}</td>
                    <td>${item.disease}</td>
                    <td>${correctnessBadge}</td>
                    <td>${correctedDisease}</td>
                </tr>`;
                
                tableBody.innerHTML += row;
            });
        }

        function renderPredictionChart(predictions) {
            const ctx = document.getElementById("predictionChart").getContext("2d");
            const correctCount = predictions.filter(p => p.is_correct).length;
            const incorrectCount = predictions.length - correctCount;

            if (window.predictionChartInstance) window.predictionChartInstance.destroy();

            window.predictionChartInstance = new Chart(ctx, {
                type: document.getElementById("predictionChartType").value,
                data: {
                    labels: ["Correct Predictions", "Incorrect Predictions"],
                    datasets: [{
                        label: "Prediction Accuracy",
                        data: [correctCount, incorrectCount],
                        backgroundColor: ["#28a745", "#dc3545"]
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        document.getElementById("predictionChartType").addEventListener("change", function() {
            renderPredictionChart(currentPredictions);
        });

        document.addEventListener("DOMContentLoaded", function () {
            fetchDonations();
            fetchPredictions();
        });
    </script>
</body>
</html>